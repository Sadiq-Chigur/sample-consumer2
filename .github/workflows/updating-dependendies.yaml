# name: Update Dependency

# on:
#   workflow_dispatch:
#     inputs:
#       version:
#         description: "New version of math-utils-library to apply"
#         required: true

# jobs:
#   update-dependency:
#     runs-on: ubuntu-latest
#     steps:
#       # 1. Checkout repository
#       - name: Checkout repository
#         uses: actions/checkout@v3
#         with:
#             token: ${{ secrets.GITHUB_TOKEN }}

#       # 2. Set up Git
#       - name: Setup Git
#         run: |
#           git config user.name "github-actions[bot]"
#           git config user.email "github-actions[bot]@users.noreply.github.com"

#      # 2. Set the new version and branch name dynamically
#       - name: Set variables
#         run: |
#           echo "NEW_VERSION=1.0.0-${{ inputs.version }}" >> $GITHUB_ENV
#           echo "BRANCH_NAME=update-math-utils-1.0.0-${{ inputs.version }}" >> $GITHUB_ENV

#       # 3. Update dependency in build.gradle
#       - name: Update math-utils-library version
#         run: |
#           NEW_VERSION="1.0.0-${{ inputs.version }}"
#           sed -i "s|implementation 'com.example.Sadiq-Chigur:math-utils-library:.*'|implementation 'com.example.Sadiq-Chigur:math-utils-library:$NEW_VERSION'|" build.gradle

#       # 4. Create a new branch
#       - name: Create branch
#         run: |
#           BRANCH_NAME="update-math-utils-1.0.0-${{ inputs.version }}"
#           git checkout -b $BRANCH_NAME

#       # 5. Commit changes
#       - name: Commit changes
#         run: |
#           git add build.gradle
#           git commit -m "Update math-utils-library to 1.0.0-${{ inputs.version }}"

#       # 6. Push branch
#       - name: Push branch
#         run: |
#           git push origin HEAD

#       # 7. Create Pull Request
#       - name: Create Pull Request
#         uses: peter-evans/create-pull-request@v5
#         with:
#           token: ${{ secrets.GITHUB_TOKEN }}
#           commit-message: "Update math-utils-library to 1.0.0-${{ inputs.version }}"
#           branch: ${{ github.head_ref }}
#           title: "Update math-utils-library version"
#           body: "This PR updates math-utils-library to version 1.0.0-${{ inputs.version }}"
#           base: develop
          


name: Auto Update math-utils-library

on:
  workflow_dispatch:
    inputs:
      version:
        description: "New version of math-utils-library to apply"
        required: true

jobs:
  update-math-utils:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout repo with proper token
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. Extract current version from build.gradle
      - name: Extract current version
        id: extract_version
        run: |
          CURRENT_VERSION=$(grep -oP "implementation 'com.example.Sadiq-Chigur:math-utils-library:\K[^']+" build.gradle)
          echo "CURRENT_VERSION=$CURRENT_VERSION" >> $GITHUB_ENV
          echo "Detected current version: $CURRENT_VERSION"

      # 3. Generate new version dynamically (add run number to make it unique)
      - name: Generate new version
        run: |
          # Extract base version (everything before the first dash)
          BASE_VERSION="${CURRENT_VERSION%%-*}"

          # Append run number to make it unique
          NEW_VERSION="${BASE_VERSION}-${GITHUB_RUN_NUMBER}"

          # Create a safe branch name
          BRANCH_NAME="update-math-utils-${NEW_VERSION//./-}"

          # Export to GitHub Actions environment
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

          echo "Generated new version: $NEW_VERSION on branch: $BRANCH_NAME"

      # 4. Update the version in build.gradle
      - name: Update math-utils-library version
        run: |
          sed -i "s|implementation 'com.example.Sadiq-Chigur:math-utils-library:.*'|implementation 'com.example.Sadiq-Chigur:math-utils-library:${NEW_VERSION}'|" build.gradle

      # 5. Create pull request with dynamic branch
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Update math-utils-library to ${NEW_VERSION}"
          title: "Update math-utils-library to ${NEW_VERSION}"
          body: "This PR updates math-utils-library from version ${{ env.CURRENT_VERSION }} to ${{ env.NEW_VERSION }}"
          base: develop
          branch: ${{ env.BRANCH_NAME }}
